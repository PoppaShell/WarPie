name: Version Consistency

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  version-check:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Version consistency check
        run: |
          echo "Checking version consistency between CHANGELOG.md and pyproject.toml..."

          CHANGELOG_VER=$(grep -m1 "^## \[" CHANGELOG.md | sed 's/.*\[\(.*\)\].*/\1/')
          PYPROJECT_VER=$(grep "^version" pyproject.toml | cut -d'"' -f2)

          echo "CHANGELOG.md version: v$CHANGELOG_VER"
          echo "pyproject.toml version: v$PYPROJECT_VER"

          if [ "$CHANGELOG_VER" != "$PYPROJECT_VER" ]; then
            echo ""
            echo "❌ VERSION MISMATCH DETECTED"
            echo ""
            echo "CHANGELOG.md shows v$CHANGELOG_VER but pyproject.toml shows v$PYPROJECT_VER"
            echo ""
            echo "To fix this, run the release preparation skill:"
            echo "  /release-preparation $CHANGELOG_VER"
            echo ""
            exit 1
          fi

          echo "✅ Versions match: v$PYPROJECT_VER"

      - name: Check git tag exists
        if: github.ref == 'refs/heads/main'
        run: |
          PYPROJECT_VER=$(grep "^version" pyproject.toml | cut -d'"' -f2)

          # Skip check for development version
          if [ "$PYPROJECT_VER" = "0.0.0" ]; then
            echo "⏭️  Skipping tag check for development version 0.0.0"
            exit 0
          fi

          echo "Checking if git tag v$PYPROJECT_VER exists..."

          if ! git tag -l | grep -q "^v$PYPROJECT_VER$"; then
            echo ""
            echo "⚠️  MISSING GIT TAG"
            echo ""
            echo "Version v$PYPROJECT_VER exists in files but not in git tags"
            echo ""
            echo "To fix this, run the release preparation skill:"
            echo "  /release-preparation $PYPROJECT_VER"
            echo ""
            exit 1
          fi

          echo "✅ Git tag v$PYPROJECT_VER exists"
